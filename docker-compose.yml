services:
    postgres:
        image: postgres:16
        environment:
            POSTGRES_DB: finpay
            POSTGRES_USER: finpay
            POSTGRES_PASSWORD: finpay
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
    pgadmin:
        image: dpage/pgadmin4:latest
        container_name: pgadmin
        environment:
            - PGADMIN_DEFAULT_EMAIL=admin@example.com
            - PGADMIN_DEFAULT_PASSWORD=finpay
            - PGADMIN_CONFIG_SERVER_MODE=False
        ports:
            - "5050:80"
        depends_on:
            - postgres
    redis:
        image: redis:7
        ports:
            - "6379:6379"

    zookeeper:
        image: confluentinc/cp-zookeeper:7.6.0
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        ports:
            - "2181:2181"

    kafka:
        image: bitnami/kafka:3.7
        environment:
            KAFKA_CFG_ZOOKEEPER_CONNECT: zookeeper:2181
            ALLOW_PLAINTEXT_LISTENER: "yes"
            KAFKA_CFG_LISTENERS: PLAINTEXT://:9092
            KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
            # Enable JMX for Kafka
            JMX_PORT: 9999
            KAFKA_JMX_OPTS: >
              -Dcom.sun.management.jmxremote
              -Dcom.sun.management.jmxremote.port=9999
              -Dcom.sun.management.jmxremote.rmi.port=9999
              -Dcom.sun.management.jmxremote.authenticate=false
              -Dcom.sun.management.jmxremote.ssl=false
              -Djava.rmi.server.hostname=kafka
        ports:
            - "9092:9092"
            - "9999:9999"
        depends_on:
            - zookeeper
    zipkin:
        image: openzipkin/zipkin
        ports:
            - "9411:9411"
    prometheus:
      image: prom/prometheus:latest
      container_name: prometheus
      volumes:
        - ./prometheus.yml:/etc/prometheus/prometheus.yml
      ports:
        - "9090:9090"

    grafana:
      image: grafana/grafana:latest
      container_name: grafana
      ports:
        - "3000:3000"
      depends_on:
        - prometheus
      environment:
        - GF_SECURITY_ADMIN_USER=admin
        - GF_SECURITY_ADMIN_PASSWORD=admin

    kafka-jmx-exporter:
      image: sscaling/jmx-prometheus-exporter
      ports:
        - "7071:7071"
      environment:
        SERVICE_PORT: 7071
        CONFIG_YML: /config/kafka-jmx.yml
      volumes:
        - ./kafka-jmx.yml:/config/kafka-jmx.yml
      depends_on:
        - kafka
volumes:
    postgres_data: